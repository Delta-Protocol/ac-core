#!/bin/bash

function clean {
	rm -rf libs
	rm -rf classes
	rm -rf test_classes
	rm -f *.jar
}

function getdeps {
if [ ! -d libs ]; then
mkdir libs
wget http://search.maven.org/remotecontent?filepath=com/madgag/spongycastle/core/1.58.0.0/core-1.58.0.0.jar -O libs/core-1.58.0.0.jar
wget http://search.maven.org/remotecontent?filepath=com/madgag/spongycastle/prov/1.58.0.0/prov-1.58.0.0.jar -O libs/prov-1.58.0.0.jar
wget http://search.maven.org/remotecontent?filepath=com/madgag/spongycastle/pkix/1.54.0.0/pkix-1.54.0.0.jar -O libs/pkix-1.54.0.0.jar
wget http://search.maven.org/remotecontent?filepath=com/madgag/spongycastle/pg/1.54.0.0/pg-1.54.0.0.jar -O libs/pg-1.54.0.0.jar
fi

}

javac=`which javac`
if [ "_$JAVA_HOME" != "_" ]; then
javac=$JAVA_HOME/bin/javac
fi


build_deps() {
    #api snippets
    pwd=`pwd`
    cd ../../api
    make
    cd $pwd
}

patch_src() {
    f=src/wallet/wallet.java
    n=`cat $f | wc -l`
    cp $f ${f}_old
    cat ${f}_old | grep "//---------------------------------------------------------------------generated by make, do not edit" -B$n > $f
    echo "//content of file: api/apitool_generated__protocol_gov_id_java" >> $f
    cat ../../api/apitool_generated__protocol_gov_id_java >> $f
    echo >> $f
    echo "//content of file: api/apitool_generated__protocol_wallet-daemon_java" >> $f
    cat ../../api/apitool_generated__protocol_wallet-daemon_java >> $f
    cat ${f}_old | grep "//-/-------------------------------------------------------------------generated by make, do not edit" -A$n >> $f
    rm ${f}_old
}
patch_src2() {
    f=src/gov/socket/protocol.java
    n=`cat $f | wc -l`
    cp $f ${f}_old
    cat ${f}_old | grep "//---------------------------------------------------------------------generated by make, do not edit" -B$n > $f
    echo "//content of file: api/apitool_generated__protocol_gov_socket_java" >> $f
    cat ../../api/apitool_generated__protocol_gov_socket_java >> $f
    echo >> $f
    cat ${f}_old | grep "//-/-------------------------------------------------------------------generated by make, do not edit" -A$n >> $f
    rm ${f}_old
}

function source_gov {
#	$javac -d classes -cp $libspath src/gov/id/*.java
#	$javac -d classes -cp $libspath src/gov/auth/*.java
#	$javac -Xlint -d classes -cp $libspath src/gov/crypto/*.java
	$javac -Xlint -d classes -cp $libspath src/gov/socket/*.java
}

function source_wallet {

	$javac -d classes -cp $libspath src/wallet/*.java
}

function source {
	rm -rf classes
	rm -f *.jar

    #api
    build_deps
    patch_src
    patch_src2

	getdeps
	mkdir -p classes

    echo "using javac=$javac"

    source_gov
#    source_wallet

	rm -f us-sdk.jar
	cd classes
	jar cf ../us-sdk.jar *
	cd ..
}

function all {
	source
return
	mkdir -p test_classes
	$javac -d test_classes -cp ".:libs/*:us-wallet-sdk.jar" tests/*.java
	rm -f us-test-sdk.jar
	cd test_classes
	jar cfe ../us-test-sdk.jar us/test/MainTest *
	cd ..
}

cmd=$1
libspath=".:libs/core-1.58.0.0.jar:libs/pg-1.54.0.0.jar:libs/pkix-1.54.0.0.jar:libs/prov-1.58.0.0.jar"


if [ "_$cmd" == "_" ]; then
	cmd="all"
fi

if [ "_$cmd" == "_all" ]; then
	all
fi

if [ "_$cmd" == "_source" ]; then
	source
fi

if [ "_$cmd" == "_clean" ]; then
	clean
fi


